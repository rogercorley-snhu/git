	@echo off
	cls
	setlocal ENABLEDELAYEDEXPANSION

::========================================================================================================================================
::	Title:		Rotate GEMonline & GEMdaily Logs -- Weekly
::========================================================================================================================================
::
::	Author:		Roger Corley
::	Created:	May 12, 2015  10:08:21 AM
::
::========================================================================================================================================
::	Description:
::========================================================================================================================================
::	
::		A log rotation batch file to be run on a weekly basis. This batch will rotate and archive the 'gemonline.log' 
::		and 'GEMdaily.cp' log files stored on the system drive (C:\). WIthout an archival process, these files 
::		continue to grow, which will eventually begin to slow any transactions between Micros and GEMpay. 
::
::---------------------------------------------------------------------------------------------------------------------------------------
::	Archives 
::---------------------------------------------------------------------------------------------------------------------------------------
::
::		These logs are archived to a directory located on the C:\ drive named _'GPayLogArchives'. 
::		The archive logs will be renamed and timestamped with the following nomenclature:
::
::.......................................................................................................................................
::		'gemonline' = 'C:\_GPayLogArchives\gemonline.<datetime>.log0<#>'
::		'GEMdaily.cp' = 'C:\_GPayLogArchives\GEMdaily.<datetime>.cp0<#>'
::.......................................................................................................................................
::
::		Each archived log will be stored for a maximum of eight (8) weeks before being deleted through the 
::		rotation process.
::
::
::---------------------------------------------------------------------------------------------------------------------------------------
::	Archive Location
::---------------------------------------------------------------------------------------------------------------------------------------
::
::		If the directory 'C:\_gemToolbox' with a subdirectory 'BatchScripts' doesn't exist, create these directories first.
::		Save this batch file as 'C:\_gemToolbox\BatchScripts\rotate_GOGD_Logs_WKLY.bat'
::
::
::---------------------------------------------------------------------------------------------------------------------------------------
::	Scheduled Task 
::---------------------------------------------------------------------------------------------------------------------------------------
::
::		Create and Enable a Scheduled Task named 'rotate_GO_GD_LOGS_WEEKLY' with the following properties:
::
::.......................................................................................................................................
::		General:	Run whether user is logged on or not:	'selected'
::				Run with highest privileges:		'checked'
::.......................................................................................................................................
::		Triggers:	Settings:	Weekly -- Start:  (Following Monday) at 4:45 AM
::				Recur every:	'1' weeks on 'Monday' -- 'checked'
::				Adv Settings:	Stop task if it runs longer than: '30 mins'
::				Enabled:	'checked'
::.......................................................................................................................................
::		Actions:	Start A Program: 'C:\_gemToolbox\BatchScripts\rotate_GOGD_Logs_WKLY.bat'
::.......................................................................................................................................
::		Settings:	Allow task to be run on demand: 	'checked'
::				Stop the task if it runs longer than:	'1 hour'
::.......................................................................................................................................
::
::
::
::
::++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
::++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
::========================================================================================================================================
::
::					----[[[ ****  DO NOT MODIFY THIS SCRIPT   ****  ]]]----
::
::========================================================================================================================================
::++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
::++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
::
::
::
::
::========================================================================================================================================
::  EXTENSION: GEMonline
::========================================================================================================================================
::
::  -------------------------------------------------------------------------------------
::	NOTE:	'gotype' MUST match the GEMonline log file extension in C:\
::  		ALWAYS include the dot ( . ) before the type!
::  -------------------------------------------------------------------------------------
::
	set "gotype=.log"

::========================================================================================================================================
::  EXTENSION: GEMdaily
::========================================================================================================================================
::
::---------------------------------------------------------------------------------------
::	NOTE:	'dtype' MUST match the GEMdaily log file extension in C:\
::  		ALWAYS include the dot ( . ) before the type!
::---------------------------------------------------------------------------------------
::
	set "dtype=.cp"
  
::========================================================================================================================================
::  DATE CONSTANTS
::========================================================================================================================================
::
	for /f "delims=" %%a in ('wmic OS Get localdatetime  ^| find "."') do set "dt=%%a"

	set "YYYY=%dt:~0,4%"
	set "MM=%dt:~4,2%"
	set "DD=%dt:~6,2%"
	set "HH=%dt:~8,2%"
	set "Min=%dt:~10,2%"
	set "Sec=%dt:~12,2%"

	set "datestamp=%YYYY%/%MM%/%DD%"
	set "timestamp=%HH%:%Min%:%Sec%"
	set "fullstamp=%datestamp% %timestamp%"
	set "logstamp=%YYYY%-%MM%-%DD%"

::========================================================================================================================================
::   FILES: GEMonline
::========================================================================================================================================
::
	set "gotype=.log"
	set "gfile=gemonline"
	set "agfile=%gfile%.%logstamp%"
	set "gpath=C:\%gfile%%gotype%"

::========================================================================================================================================
::  FILES: GEMdaily
::========================================================================================================================================
::
	set "dtype=.cp"
	set "dfile=GEMdaily"  
	set "adfile=%dfile%.%logstamp%"
	set "dpath=C:\%dfile%%dtype%"

::========================================================================================================================================
::  FILES: Archives
::========================================================================================================================================
::
	set "apath=C:\_GPayLogArchives\"

::========================================================================================================================================
::  FILES: Import Log File
::========================================================================================================================================
::
	set "log=C:\_GPayLogArchives\_rotateGOGDLogs.log01"


::========================================================================================================================================
::  BEGIN BATCH ROTATIONS
::========================================================================================================================================
::
::
::
::---------------------------------------------------------------------------------------------------------------------------------------
:FileRotations
::---------------------------------------------------------------------------------------------------------------------------------------

		echo ============================================================================== >> %log%
		echo %fullstamp% : [ BEGIN ] GEMOnline & GEMdaily Log Rotations >> %log%
		echo ============================================================================== >> %log%
		echo. >> %log%
		echo .............................................................................. >> %log%
		echo .............................................................................. >> %log%
		echo. >> %log%

		echo %fullstamp% : Starting Log Rotations >> %log%
		echo. >> %log%
		echo .............................................................................. >> %log%

::---------------------------------------------------------------------------------------------------------------------------------------
:chkGO
::---------------------------------------------------------------------------------------------------------------------------------------

	if exist %gpath% (
		echo !fullstamp! : [ CHECK GEMonline ] : !gfile!!gtype! found. >> !log!
		echo .............................................................................. >> !log!
		echo. >> !log!
		goto rotateGO
	) else (
		echo ============================================================================== >> !log!
		echo ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ >> !log!
		echo !fullstamp! : [ CHECK  GEMonline : ERROR ] : '!gfile!!gtype' NOT FOUND >> !log! 
		echo ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ >> !log!
		echo ============================================================================== >> !log!
		echo. >> !log!           
	)
	
	goto chkGD

::---------------------------------------------------------------------------------------------------------------------------------------
:rotateGO
::---------------------------------------------------------------------------------------------------------------------------------------

	if exist %apath%*.log08 del /f /q %apath%*.log08
	if exist %apath%*.log07 copy %apath%*.log07 %apath%*.log08
	if exist %apath%*.log06 copy %apath%*.log06 %apath%*.log07
	if exist %apath%*.log05 copy %apath%*.log05 %apath%*.log06
	if exist %apath%*.log04 copy %apath%*.log04 %apath%*.log05
	if exist %apath%*.log03 copy %apath%*.log03 %apath%*.log04
	if exist %apath%*.log02 copy %apath%*.log02 %apath%*.log03
	if exist %apath%*.log01 copy %apath%*.log01 %apath%*.log02

	if exist %gpath% move %gpath% %apath%%agfile%.log01

	goto chkGD

::---------------------------------------------------------------------------------------------------------------------------------------
:chkGD
::---------------------------------------------------------------------------------------------------------------------------------------

	if exist %dpath% (
		echo !fullstamp! : [ CHECK GEMonline ] : !dfile!!dtype! found. >> !log!
		echo .............................................................................. >> !log!
		echo. >> !log!
		goto rotateGD
	) else (
		echo ============================================================================== >> !log!
		echo ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ >> !log!
		echo !fullstamp! : [ CHECK  GEMonline : ERROR ] : '!dfile!!dtype' NOT FOUND >> !log! 
		echo ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ >> !log!
		echo ============================================================================== >> !log!
		echo. >> !log!           
	)
	
	goto done

::---------------------------------------------------------------------------------------------------------------------------------------
:rotateGD
::---------------------------------------------------------------------------------------------------------------------------------------

	if exist %apath%*.cp08 del /f /q %apath%*.cp08
	if exist %apath%*.cp07 copy %apath%*.cp07 %apath%*.cp08
	if exist %apath%*.cp06 copy %apath%*.cp06 %apath%*.cp07
	if exist %apath%*.cp05 copy %apath%*.cp05 %apath%*.cp06
	if exist %apath%*.cp04 copy %apath%*.cp04 %apath%*.cp05
	if exist %apath%*.cp03 copy %apath%*.cp03 %apath%*.cp04
	if exist %apath%*.cp02 copy %apath%*.cp02 %apath%*.cp03
	if exist %apath%*.cp01 copy %apath%*.cp01 %apath%*.cp02

	if exist %dpath% move %dpath% %apath%%adfile%.cp01

	goto done

::---------------------------------------------------------------------------------------------------------------------------------------
:done
::---------------------------------------------------------------------------------------------------------------------------------------

	echo ============================================================================== >> %log%
	echo %fullstamp% : [ END ] GEMOnline & GEMdaily Log Rotations Completed >> %log%
	echo ============================================================================== >> %log%
	echo. >> %log%
	echo .............................................................................. >> %log%
	echo .............................................................................. >> %log%
	echo. >> %log%
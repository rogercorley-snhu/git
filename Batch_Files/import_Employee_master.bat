  @echo off
  cls
  setlocal ENABLEDELAYEDEXPANSION


::-------------------------------------------------------------------------------------------------------
::+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
::
::                  [ ****      DO NOT MODIFY IN THIS SECTION         ****  ]
::
::+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
::-------------------------------------------------------------------------------------------------------
::
::
::=======================================================================================================
::                  [ ****       DATE CONSTANTS : DO NOT MODIFY       ****  ]
::=======================================================================================================

  for /f "delims=" %%a in ('wmic OS Get localdatetime  ^| find "."') do set "dt=%%a"

  set "YYYY=%dt:~0,4%"
  set "MM=%dt:~4,2%"
  set "DD=%dt:~6,2%"
  set "HH=%dt:~8,2%"
  set "Min=%dt:~10,2%"
  set "Sec=%dt:~12,2%"

  set "datestamp=%YYYY%/%MM%/%DD%"
  set "timestamp=%HH%:%Min%:%Sec%"
  set "fullstamp=%datestamp% %timestamp%"
  set "logstamp=%YYYY%-%MM%-%DD%"

::=======================================================================================================
::=======================================================================================================
::+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
::
::
::=======================================================================================================
::  ENVIRONMENT VARIABLES : Directories 
::=======================================================================================================
::  VERIFY all required Environment Variables have been created in System Properties
::  -- To verify, right-click 'My Computer', click 'Properties', select 'Advanced' tab ...
::  -- and click 'Environment Variables'. If they exist, you will see them in 'User variables for'.
::
::  IF ENVIRONMENT VARIABLES FOR GEM DON'T EXIST...
::  -- Create a batch file (.bat) named 'setEnvVar.bat'. Copy the set variables listed below
::  -- and paste them into the new .bat file. Save the .bat file in the GEM directory.
::  !! YOU MUST SAVE AND RUN THIS .BAT FILE FROM THE GEM ROOT DIRECTORY.
::  -- Run 'setEnvVar.bat' and click 'space' within the command line screen when prompted.
::  -- Verify that GEM environment variables now exist. 
::
::  -- You may now use the environment variables in place of the full path in this script.
::  !! When referencing a path using these variables, DO NOT PLACE A TRAILING SLASH ' \ ' in the script.
::  !! Using the trailing slash ' \ ' will cause an error!
::
::  -- example - CORRECT:   %GIMPEXP%employee.txt
::  -- example - INCORRECT: %GIMPEXP%\employee.txt
::
::-------------------------------------------------------------------------------------------------------
::  TO CREATE '.\GEM\setEnvVar.bat' 
::-------------------------------------------------------------------------------------------------------
::  -- Use this code to create the required batch file.
::  !! REMEMBER TO SAVE AND RUN THIS BATCH FILE FROM THE GEM DIRECTORY !!
::-------------------------------------------------------------------------------------------------------
::  
::  @echo off
::  
::  setx GEM %~dp0
::  setx GIMPEXP %~dp0ImportExport\
::  setx GARCH %~dp0ImportExport\Archive\
::  setx GIMPEMP %~dp0ImportExport\Archive\ImportEmployees\
::  setx GBAD %~dp0ImportExport\Archive\ImportEmployees\BadFiles\
::  setx GSCRIPTS %~dp0ImportExport\_Scripts\
::  
::  pause
::
::-------------------------------------------------------------------------------------------------------
::  ENVIRONMENT VARIABLES  
::-------------------------------------------------------------------------------------------------------
::  You may now reference these variables with the following.
::  Only use the %...% variable. Anything past the last % is just a reference to the directory.
::-------------------------------------------------------------------------------------------------------
::
::  %GEM% = 'currentDrive\GEM\'
::  %GIMPEXP% = 'currentDrive\GEM\ImportExport\'
::  %GARCH% = 'currentDrive\GEM\ImportExport\Archive\'
::  %GIMPEMP% = 'currentDrive\GEM\ImportExport\Archive\ImportEmployees\'
::  %GBAD% = 'currentDrive\GEM\ImportExport\Archive\ImportEmployees\BadFiles\'
::  %GSCRIPTS% = 'currentDrive\GEM\ImportExport\_Scripts\'
::
::  
::=======================================================================================================
::  /ENVIRONMENT VARIABLES : Directories
::=======================================================================================================
::+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
::
::
::-------------------------------------------------------------------------------------------------------
::+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
::
::                  [ ****       END DO NOT MODIFY SECTION            ****  ]
::
::+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
::-------------------------------------------------------------------------------------------------------



::-------------------------------------------------------------------------------------------------------
::+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
::
::                  [ ****  MODIFY VARIABLE VALUES AS NEEDED          ****  ]
::                  [ ****  READ ALL INSTRUCTIONS BEFORE MODIFYING    ****  ]
::                  [ ****  DO NOT REORDER VARIABLE POSITIONS         ****  ]
::
::+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
::-------------------------------------------------------------------------------------------------------
::
::
::=======================================================================================================
::  CONFIGURE VARIABLES : ENVIRONMENT : Filenames
::=======================================================================================================

::  'filetype' MUST match the demographic import file type. 
::  'tmptype' is a constant used in funcRemoveHeader. DO NOT MODIFY.
::  -------------------------------------------------------------------------------------
  set "filetype=txt"  
  set "tmptype=tmp"

::  'impfile' MUST match the demographic file name WITHOUT file extension.  
::  'impfull' is the full filename of 'impfile' WITH file extension.
::  -------------------------------------------------------------------------------------
  set "impfile=employee"    
  set "impfull=%impfile%.%filetype%"

::  'imppath' is the full path and file name of the demographic file WITH file extension. 
::  'temppath' is the full path-filename of the temporary file created in funcRemoveHeader
::  -------------------------------------------------------------------------------------
  set "imppath=%GIMPEXP%%impfile%.%filetype%"
  set "temppath=%GIMPEXP%%impfile%.%tmptype%"

::  'archfull' is the variable for the full archive file name WITHOUT file extension.
::  'archpath' is the variable for the full path-filename of 'archfull' WITHOUT file extension 
::  -------------------------------------------------------------------------------------
  set "archfull=%impfile%.%logstamp%"
  set "archpath=%GIMPEMP%%archfull%"
  set "log=%GIMPEMP%_%impfile%.log01"

::  'badfile' is the variable for the full corrupt file name WITHOUT file extension.
::  'badpath' is the variable for the full path-filename of 'badfile' WITHOUT file extension 
::  -------------------------------------------------------------------------------------
  set "badfull=bad.%impfile%.%logstamp%"
  set "badpath=%GBAD%%badfull%"
  set "badlog=%GBAD%_%impfile%.log01"

::  Set 'exp_num_lines' value to the minimum number of expected lines in the demographic file.
::  -------------------------------------------------------------------------------------
  set "exp_num_lines=10"

::=======================================================================================================
::  /CONFIGURE VARIABLES : ENVIRONMENT : Filenames
::=======================================================================================================
::+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


::=======================================================================================================
::  CONFIGURE VARIABLES : SQL SERVER : IMPORT SCRIPT 
::=======================================================================================================

::  MUST match sModule in SQL table cfgScriptParams
::  -------------------------------------------------------------------------------------
  set "module=171"
    
::  "SQLNAME=sqlservername" MUST be enclosed wihtin double-quotes ( "SQLNAME=xxxxx" )
::  -------------------------------------------------------------------------------------
::  !! If using local for SQL Server name, set variable to "SQLNAME=(local)" - Parenthesis are REQUIRED !!
::-------------------------------------------------------------------------------------------------------
  set "sqlname=d109gemdb"

::=======================================================================================================
::  /CONFIGURE VARIABLES : SQL SERVER : IMPORT SCRIPT 
::=======================================================================================================
::+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++



::-------------------------------------------------------------------------------------------------------
::+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
::
::                  [ ****  DO NOT MODIFY ANYTHING PAST THIS SECTION  ****  ]
::
::+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
::-------------------------------------------------------------------------------------------------------
::
::
::=======================================================================================================
::  BEGIN BATCH TASKS
::=======================================================================================================
::
::
::=======================================================================================================
:Begin_Import_Job
::=======================================================================================================
    echo ============================================================================== >> %log%
    echo %fullstamp% : [ BEGIN ] Importing %impfull% >> %log%
    echo ============================================================================== >> %log%
    echo. >> %log%
    echo .............................................................................. >> %log%
    echo .............................................................................. >> %log%
    echo. >> %log%


::=======================================================================================================
:testImportFileExists
::=======================================================================================================
    echo ============================================================================== >> %log%
    echo %fullstamp% : [ CHECK ] BEGIN FUNCTION: CHECK FILES EXISTS >> %log%
    echo ============================================================================== >> %log%
    echo. >> %log%

  if exist %imppath% (
    echo !fullstamp! : [ CHECK ] : '!impfull!' found. >> !log!
    echo. >> !log!
    echo ============================================================================== >> !log!
    echo !fullstamp! : [ CHECK ] : CLOSE FUNCTION: CHECK FILES EXISTS  >> !log!
    echo ============================================================================== >> !log!
    echo. >> !log!
    echo .............................................................................. >> !log!
    echo .............................................................................. >> !log!
    echo. >> !log!
    goto funcRemoveHeader 
    ) else (
    echo ============================================================================== >> !log!
    echo ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ >> !log!
    echo !fullstamp! : [ CHECK : ERROR ] : '!impfull!' NOT FOUND >> !log! 
    echo ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ >> !log!
    echo ============================================================================== >> !log!
    echo. >> !log!
    )
  
  goto Done

::=======================================================================================================
::  /CHK_ImportFileExist
::=======================================================================================================
::+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


::=======================================================================================================
:funcRemoveHeader
::=======================================================================================================

    echo ============================================================================== >> %log%
    echo %fullstamp% : [ HEADER ] BEGIN FUNCTION: REMOVE HEADER >> %log%
    echo ============================================================================== >> %log%
    echo. >> %log%

  for /f "skip=1 delims=*" %%a in (%imppath%) do (
    echo %%a >> %temppath%    
  )

  xcopy %temppath% %imppath% /y
  del %temppath% /f /q

    echo. >> %log%
    echo %fullstamp% : [ HEADER ] Header row removed from %impfull%. >> %log%
    echo. >> %log%

    echo ============================================================================== >> %log%
    echo %fullstamp% : [ HEADER ] END FUNCTION: REMOVE HEADER >> %log%
    echo ============================================================================== >> %log%
    echo. >> %log%

goto funcLineCount

::=======================================================================================================
::  /funcRemoveHeader
::=======================================================================================================
::+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++



::=======================================================================================================
:funcLineCount
::=======================================================================================================

    echo ============================================================================== >> %log%
    echo %fullstamp% : [ COUNT ] BEGIN : FUNCTION: Line Count >> %log%
    echo ============================================================================== >> %log%
    echo. >> %log%
    
    echo %fullstamp% : [ COUNT ] Counting Number Of Lines In '%impfull%' >> %log%

  set /p =COUNT: < nul 
  for /f %%C in ('Find /V /C "" ^< %imppath%') do set COUNT=%%C 

    echo %fullstamp% : [ COUNT ] %impfull% has %COUNT% lines. >> %log%

  if %COUNT% GTR %exp_num_lines% (
    echo. >> !log!
    echo ============================================================================== >> !log!
    echo !fullstamp! : [ COUNT ] END : FUNCTION: Line Count >> !log!
    echo ============================================================================== >> !log!
    echo. >> !log!
    echo .............................................................................. >> !log!
    echo .............................................................................. >> !log!
    
    goto funcSQLImport 
    ) else (

    echo. >> !log!
    echo ============================================================================== >> !log!
    echo ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ >> !log!
    echo !fullstamp! [ BADFILE ] : IMPORT FILE : LINE COUNT >> !log! 
    echo ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ >> !log!
    echo ============================================================================== >> !log!
    echo. >> !log!
    echo !fullstamp! : [ BADFILE ] : Line Count Test - FAILED. >> !log!
    echo !fullstamp! : [ BADFILE ] : '!impfull!' contains !COUNT! lines. >> !log! 
    echo !fullstamp! : [ BADFILE ] : Expecting !exp_num_lines! lines minimum. >> !log!
    echo !fullstamp! : [ BADFILE ] : Archiving to '\ImportEmployees\badarch' >> !log! 
    echo. >> !log!
    )
    
  goto funcBadFile

::=======================================================================================================
::  /funcLineCount
::=======================================================================================================
::+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


::=======================================================================================================
:funcSQLImport
::=======================================================================================================
    echo. >> %log%
    echo ============================================================================== >> %log%
    echo %fullstamp% : [ IMPORT ] Begin SQL Import Module : '%impfull%' >> %log%
    echo ============================================================================== >> %log%
    echo. >> %log%

    echo %fullstamp% : [ IMPORT ] Starting SQL Import >> %log%
    


::  %GEM%runscript script=Import_v1_70.gsf,pw=gemie,svr=%sqlname%,core=1,module=%module%,include=gsf.txt

    echo %fullstamp% : [ IMPORT ] SQL Import successful. >> %log%
    echo.>> %log%


    echo ============================================================================== >> %log%
    echo %fullstamp% : [ IMPORT ] Exiting SQL Import Module >> %log%
    echo ============================================================================== >> %log%
    echo. >> %log%
    echo .............................................................................. >> %log%
    echo .............................................................................. >> %log%  
    echo. >> %log%
  goto funcArchive

::=======================================================================================================
::  /funcSQLImport 
::=======================================================================================================
::+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


::=======================================================================================================
:funcArchive
::=======================================================================================================
    echo ============================================================================== >> %log%
    echo %fullstamp% : [ ARCHIVE ] Begin Archive File Rotations >> %log%
    echo ============================================================================== >> %log%
    echo. >> %log%


  if exist %GIMPEMP%.d08 del /Q %GIMPEMP%.d08
  if exist %GIMPEMP%*.d07 copy %GIMPEMP%*.d07 %GIMPEMP%*.d08
  if exist %GIMPEMP%*.d06 copy %GIMPEMP%*.d06 %GIMPEMP%*.d07
  if exist %GIMPEMP%*.d05 copy %GIMPEMP%*.d05 %GIMPEMP%*.d06
  if exist %GIMPEMP%*.d04 copy %GIMPEMP%*.d04 %GIMPEMP%*.d05
  if exist %GIMPEMP%*.d03 copy %GIMPEMP%*.d03 %GIMPEMP%*.d04
  if exist %GIMPEMP%*.d02 copy %GIMPEMP%*.d02 %GIMPEMP%*.d03
  if exist %GIMPEMP%*.d01 copy %GIMPEMP%*.d01 %GIMPEMP%*.d02


    echo %fullstamp% : [ ARCHIVE ] Archived Files Rotated Successfully >> %log%


  move %imppath% %archpath%.d01

    echo %fullstamp% : [ ARCHIVE ] '%impfull%' -- '%archfull%' >> %log%
    echo. >> %log%

    echo ============================================================================== >> %log%
    echo %fullstamp% : [ ARCHIVE ] : Employee File Archive Complete >> %log% 
    echo ============================================================================== >> %log%  
    echo. >> %log%
    echo .............................................................................. >> %log%
    echo .............................................................................. >> %log%
    echo. >> %log%
  goto Done

::=======================================================================================================
::  /funcArchive
::=======================================================================================================
::+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


::=======================================================================================================
:funcBadFile
::=======================================================================================================

::-------------------------------------------------------------------------------------------------------
::  ERROR MSG : BAD LOG FILE 
::-------------------------------------------------------------------------------------------------------

    echo ============================================================================== >> %badlog%
    echo ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ >> %badlog%
    echo %fullstamp% : ERROR : IMPORT FILE : LINE COUNT >> %badlog%
    echo ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ >> %badlog%
    echo ============================================================================== >> %badlog%
    echo. >> %badlog%
    echo ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ >> %badlog%
    echo %fullstamp% : [ BADFILE ] : Line Count Test - FAILED. >> %badlog%
    echo %fullstamp% : [ BADFILE ] : '%impfull%' contains %COUNT% lines. >> %badlog% 
    echo %fullstamp% : [ BADFILE ] : Expecting %exp_num_lines% lines minimum. >> %badlog%
    echo ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ >> %badlog%
    echo. >> %badlog%


::------------------------------------------------------------------------------------------------------- 

    echo ------------------------------------------------------------------------------ >> %log%
    echo %fullstamp% : [ BADFILE ] Begin Archived Corrupt File Rotations >> %log%
    echo ------------------------------------------------------------------------------ >> %log%
    echo. >> %log%

    ::-----------------------------------------------------------------------------------------------

    echo ------------------------------------------------------------------------------ >> %badlog%
    echo %fullstamp% : [ BADFILE ] Begin Archived Corrupt File Rotations >> %badlog%
    echo ------------------------------------------------------------------------------ >> %badlog%
    echo. >> %badlog%

::-------------------------------------------------------------------------------------------------------

  if exist %badpath%*.d08 del /Q %badpath%*.d08
  if exist %badpath%*.d07 copy %badpath%*.d07 %badpath%*.d08
  if exist %badpath%*.d06 copy %badpath%*.d06 %badpath%*.d07
  if exist %badpath%*.d05 copy %badpath%*.d05 %badpath%*.d06
  if exist %badpath%*.d04 copy %badpath%*.d04 %badpath%*.d05
  if exist %badpath%*.d03 copy %badpath%*.d03 %badpath%*.d04
  if exist %badpath%*.d02 copy %badpath%*.d02 %badpath%*.d03
  if exist %badpath%*.d01 copy %badpath%*.d01 %badpath%*.d02

::-------------------------------------------------------------------------------------------------------

    echo %fullstamp% : [ BADFILE ] Archived corrupt files rotation successful. >> %log%

    ::-----------------------------------------------------------------------------------------------

    echo %fullstamp% : [ BADFILE ] Archived corrupt files rotation successful. >> %badlog%

::-------------------------------------------------------------------------------------------------------

  move %imppath% %badpath%.d01    

::-------------------------------------------------------------------------------------------------------


    echo %fullstamp% : [ BADFILE ] Archived corrupt %impfull%. >> %log%
    echo. >> %log%
    echo ------------------------------------------------------------------------------ >> %badlog%

    ::-----------------------------------------------------------------------------------------------

    echo %fullstamp% : [ BADFILE ] Archived corrupt %impfull%. >> %badlog%
    echo. >> %badlog%
    echo ------------------------------------------------------------------------------ >> %badlog%
    echo. >> %badlog%

::-------------------------------------------------------------------------------------------------------

    echo ============================================================================== >> %log%
    echo ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ >> %log%
    echo %fullstamp% : [ BADFILE ] Exiting Bad File Processes  >> %log% 
    echo ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ >> %log%
    echo ============================================================================== >> %log%  
    echo. >> %log%
    echo .............................................................................. >> %log%
    echo .............................................................................. >> %log%
    echo. >> %log%


::-------------------------------------------------------------------------------------------------------

    echo ============================================================================== >> %badlog%
    echo ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ >> %badlog%
    echo %fullstamp% : [ BADFILE ] Exiting Bad File Processes >> %badlog% 
    echo ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ >> %badlog%
    echo ============================================================================== >> %badlog%  
    echo. >> %badlog%
    echo .............................................................................. >> %badlog%
    echo .............................................................................. >> %badlog%
    echo. >> %badlog%

  goto Done

::=======================================================================================================
::  /funcBadFile
::=======================================================================================================
::+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


::=======================================================================================================
:Done
::=======================================================================================================
    echo ============================================================================== >> %log%
    echo %fullstamp% : [ END ] Exiting Master Employee Import Job >> %log%
    echo ============================================================================== >> %log%
    echo. >> %log%
    echo. >> %log%
    echo ****************************************************************************** >> %log%
    echo ****************************************************************************** >> %log%
    echo ****************************************************************************** >> %log%
    echo. >> %log%
    echo. >> %log%

::=======================================================================================================
::  /Done
::=======================================================================================================
::+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++



::=======================================================================================================
::  /BEGIN BATCH TASKS
::=======================================================================================================

